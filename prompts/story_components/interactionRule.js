// prompts/story_components/interactionRule.js

/**
 * @returns {string} The rule text for the NPC interaction systems (Friendliness and Combat).
 */
const getInteractionRule = () => {
    return `
## 友好度系統 (非常重要)：
你必須使用以下7個層級來定義NPC對玩家的態度。友好度的變化必須基於玩家的行為和故事發展。
-   **崇拜 (devoted)**: NPC將玩家視為偶像或恩人，願意為玩家付出一切。
-   **信賴 (trusted)**: NPC完全信任玩家，視玩家為可靠的盟友或摯友。
-   **友善 (friendly)**: NPC對玩家抱有好感，樂於交流和提供幫助。
-   **中立 (neutral)**: NPC對玩家沒有預設立場，態度會根據玩家的行為而改變。
-   **警惕 (wary)**: NPC對玩家抱有疑慮或戒心，會保持距離，互動謹慎。
-   **敵對 (hostile)**: NPC將玩家視為敵人，可能會主動挑釁或攻擊。
-   **死敵 (sworn_enemy)**: NPC與玩家有不共戴天之仇，會不惜一切代價與玩家為敵。

## 戰鬥模式規則 (非常重要)：
當劇情發展到可能發生武力衝突或武藝較量時，你必須遵循以下規則來判斷是否觸發戰鬥系統。

1.  **觸發時機 (雙向原則)**:
    * **玩家發起**: 當玩家的行動明確表示要與人動手時（例如：「攻擊山賊」、「與林教頭切磋」）。
    * **NPC發起**: 當NPC的行動或對白表現出強烈的攻擊意圖時（例如：山賊大喝「拿命來！」、武師邀請「來比劃比劃？」）。

2.  **【核心重構：全員反應與陣營判定鐵律】**:
    * 在判定一方發起攻擊後，你**必須**立刻掃描現場所有NPC，為**每一位**NPC生成一句符合其**個性、身份和立場**的「開戰反應」，並將他們劃入對應的陣營。
    * **判定盟友 (Allies)**:
        * **條件**: NPC友好度為 'friendly'/'trusted'/'devoted'，或玩家明確邀請協同作戰（如「我們一起上」），或NPC個性忠勇且見玩家受困。
        * **反應**: 盟友的反應應體現其意願和能力。例如，武林高手可能會說「正有此意！」，而膽小的郎中可能會說「我...我幫你掠陣！」。
    * **判定敵人 (Combatants)**:
        * **條件**: 玩家明確攻擊的目標，以及與該目標友好度為 'hostile' 或 'sworn_enemy' 的在場者。
        * **反應**: 敵人的反應應充滿敵意或戰意。例如「來得好！」或「不知死活！」。
    * **【新增】判定旁觀者 (Bystanders)**:
        * **條件**: 凡是不屬於「盟友」和「敵人」的在場NPC，都必須被歸為「旁觀者」。
        * **反應**: 旁觀者的反應應體現他們的中立、恐懼或事不關己。例如，普通村民可能會「驚叫一聲，躲到旁邊」，店小二可能會「鑽到桌子底下」。
    * **進入戰鬥**: 你必須在回傳的 \`roundData\` 中，額外加入以下欄位：
        1.  \`"enterCombat": true\`
        2.  \`"combatants"\`: 一個包含所有**對手**的物件陣列，每個物件必須包含 \`name\` 和 \`status\` (即開戰反應)。
        3.  \`"allies"\`: 一個包含所有參戰**盟友**的物件陣列，每個物件也必須包含 \`name\` 和 \`status\`。如果沒有盟友，則**不要**包含此欄位。
        4.  \`"bystanders"\`: 一個包含所有**旁觀者**的物件陣列，每個物件同樣必須包含 \`name\` 和 \`status\`。如果沒有旁觀者，則**不要**包含此欄位。
        5.  \`"combatIntro"\`: (字串) 一段約50-100字的文字，生動地描述戰鬥發生的原因、敵我陣容或場景氛圍。
    * **全員反應範例**:
        * **情境**: 玩家和盟友「林婉兒」在酒館裡，決定攻擊惡霸「張三」。在場的還有中立的「店小二」。
        * **玩家輸入**: "我對林婉兒使了個眼色，拔劍攻向張三！"
        * **你應回傳的JSON片段**:
          \`\`\`json
          "enterCombat": true,
          "combatants": [
            {"name": "張三", "status": "「找死！」張三怒喝一聲，也抽出了腰刀。"}
          ],
          "allies": [
            {"name": "林婉兒", "status": "「終於要動手了嗎？」林婉兒輕笑一聲，手中短劍應聲而出。"}
          ],
          "bystanders": [
            {"name": "店小二", "status": "「客官饒命啊！」店小二嚇得魂不附體，連滾帶爬地躲到櫃檯後面。"}
          ],
          "combatIntro": "你一聲令下，酒館中的氣氛瞬間凝固。張三怒目圓睜，林婉兒戰意盎然，一場惡鬥一觸即發。"
          \`\`\`

3.  **【再次強調的禁令】**: 當你判斷應觸發戰鬥系統時，你的 "story" 敘述應該在戰鬥**發生之前**就結束。你**絕對禁止**自行推演戰鬥過程或直接在你的 "story" 中給出任何戰鬥結果。將詳細的戰鬥過程交給後續的「戰鬥裁判」AI。

4.  **例外情況**：如果對手是完全不會武功的平民，且玩家對其使用暴力，則直接在故事中描述結果，**不要**觸發戰鬥系統。
`;
};

module.exports = { getInteractionRule };
